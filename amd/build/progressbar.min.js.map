{"version":3,"file":"progressbar.min.js","sources":["../src/progressbar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Completion Progress block progress bar behaviour.\n *\n * @module     block_completion_progress/progressbar\n * @copyright  2020 Jonathon Fowler <fowlerj@usq.edu.au>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/log', 'core/templates', 'core/utils'],\n    function($, Ajax, Log, Templates, Utils) {\n        /**\n         * Show progress event information for a cell.\n         * @param {Event} event\n         */\n        function showInfo(event) {\n            var cell = $(this);\n            var container = cell.closest('.block_completion_progress .barContainer');\n            var visibleinfo = container.siblings('.progressEventInfo:visible');\n            var infotoshow = container.siblings('.progressEventInfo[data-inforef=' + cell.data('inforef') + ']');\n\n            if (!visibleinfo.is(infotoshow)) {\n                visibleinfo.hide();\n                infotoshow.show();\n            }\n\n            event.preventDefault();\n        }\n\n        /**\n         * Show all progress event information (for accessibility).\n         * @param {Event} event\n         */\n        function showAllInfo(event) {\n            var initialinfo = $(this).closest('.progressEventInfo');\n\n            initialinfo.siblings('.progressEventInfo').show();\n            initialinfo.hide();\n\n            event.preventDefault();\n        }\n\n        /**\n         * Navigate to a cell's activity location.\n         */\n        function viewActivity() {\n            var cell = $(this);\n            var container = cell.closest('.block_completion_progress .barContainer');\n            var infotoshow = container.siblings('.progressEventInfo[data-inforef=' + cell.data('inforef') + ']');\n            var infolink = infotoshow.find('a').first();\n            if (infolink.prop('onclick') !== null) {\n                infolink.click();\n            } else {\n                document.location = infolink.prop('href');\n            }\n        }\n\n        /**\n         * Scroll the bar corresponding to the arrow clicked.\n         * @param {Event} event\n         */\n        function scrollContainer(event) {\n            var barrow = $(this).closest('.block_completion_progress .barContainer').find('.barRow');\n            var amount = event.data * barrow.prop('scrollWidth') * 0.15;\n\n            barrow.prop('scrollLeft', barrow.prop('scrollLeft') + amount);\n\n            event.preventDefault();\n        }\n\n        /**\n         * Show or hide the scroll arrows based on the visible position.\n         */\n        function checkArrows() {\n            var barrow = $(this);\n            var barcontainer = barrow.closest('.block_completion_progress .barContainer');\n            var leftarrow = barcontainer.find('.left-arrow-svg');\n            var rightarrow = barcontainer.find('.right-arrow-svg');\n            var scrolled = barrow.prop('scrollLeft');\n            var scrollWidth = barrow.prop('scrollWidth') - barrow.prop('offsetWidth');\n            var threshold = Math.floor(barrow.find('.progressBarCell:first-child').width() * 0.25);\n\n            if (document.dir === 'rtl') {\n                scrolled = -scrolled;\n\n                if (scrolled > threshold) {\n                    rightarrow.css('display', 'block');\n                } else {\n                    rightarrow.css('display', 'none');\n                }\n                if (scrollWidth > threshold && scrolled < scrollWidth - threshold) {\n                    leftarrow.css('display', 'block');\n                } else {\n                    leftarrow.css('display', 'none');\n                }\n            } else {\n                if (scrolled > threshold) {\n                    leftarrow.css('display', 'block');\n                } else {\n                    leftarrow.css('display', 'none');\n                }\n                if (scrollWidth > threshold && scrolled < scrollWidth - threshold) {\n                    rightarrow.css('display', 'block');\n                } else {\n                    rightarrow.css('display', 'none');\n                }\n            }\n        }\n\n        /**\n         * Place the 'now' marker in the centre of the scrolled bar.\n         * @param {jQuery} barel optional bar element. If not passed, all bars will be positioned.\n         */\n        function positionNow(barel) {\n            var barrows;\n            if (typeof barel !== 'undefined') {\n                barrows = barel.find('.barRow');\n            } else {\n                barrows = $('.block_completion_progress .barRow');\n            }\n            var nowicons = barrows.find('.nowDiv .icon');\n            nowicons.each(function() {\n                var nowicon = $(this);\n                var barrow = nowicon.closest('.block_completion_progress .barRow');\n\n                barrow.prop('scrollLeft', 0);\n                barrow.prop('scrollLeft', nowicon.offset().left - barrow.offset().left -\n                    barrow.width() / 2);\n            });\n            barrows.each(checkArrows);\n        }\n\n        /**\n         * Re-render the blocks which have a cell for the given cmid.\n         * @param {String} cmid\n         */\n        function rerenderBlocksWithCmid(cmid) {\n            var blocks = $('.block.block_completion_progress:has(.progressBarCell[data-inforef$=\"-' + cmid + '\"])');\n            blocks.each(function() {\n                let block = $(this);\n                let blockcontent = block.find('div.block_completion_progress');\n                let barcontainer = block.find('.barContainer');\n                let courseid = barcontainer.data('courseid');\n                let instanceid = barcontainer.data('instanceid');\n                let userid = barcontainer.data('userid');\n\n                Log.debug(`block_completion_progress: reloading course ${courseid} blockinstance ${instanceid} user ${userid}`);\n                Ajax.call(\n                    [{\n                        methodname: 'block_completion_progress_get_blockinstance_data',\n                        args: {\n                            courseid,\n                            instanceid,\n                            userid,\n                        },\n                        done: function(response) {\n                            Templates.render('block_completion_progress/completion_progress', response)\n                                .done(function(html, js) {\n                                    let newcontent = Templates.replaceNode(blockcontent, html, js);\n                                    positionNow($(newcontent[0]));\n                                })\n                                .fail(ex => Log.debug('block_completion_progress: error rendering template to reload ' +\n                                    `course ${courseid} blockinstance ${instanceid} user ${userid} -- ${ex.errorcode}`));\n                        },\n                        fail: ex => Log.debug('block_completion_progress: error making ajax call to reload ' +\n                            `course ${courseid} blockinstance ${instanceid} user ${userid} -- ${ex.errorcode}`),\n                    }],\n                    true, true, true\n                );\n            });\n        }\n\n        /**\n         * Set up event handlers to drive all instances of progress bars which may exist.\n         */\n        function init() {\n            // Show information elements on hover or tap.\n            $(document.body).on('touchstart mouseover', '.block_completion_progress .progressBarCell', showInfo);\n\n            // Navigate to the activity when its cell is clicked.\n            $(document.body).on('click', '.block_completion_progress .progressBarCell[data-haslink=true]', viewActivity);\n\n            // Show all information elements when the 'show all' link is clicked.\n            $(document.body).on('click', '.block_completion_progress .progressShowAllInfo', showAllInfo);\n\n            // Handle the presentation of scroll arrows when in scroll mode.\n            document.addEventListener('scroll', function(e) {\n                if (e.target.matches && e.target.matches('.block_completion_progress .barRow')) {\n                    checkArrows.call(e.target);\n                }\n            }, true);\n            $(document.body).on('click', '.block_completion_progress .left-arrow-svg', -1, scrollContainer);\n            $(document.body).on('click', '.block_completion_progress .right-arrow-svg', 1, scrollContainer);\n            $(window).resize(() => $('.block_completion_progress .barRow').each(checkArrows));\n            $(document).on('theme_boost/drawers:shown theme_boost/drawers:hidden',\n                Utils.debounce(() => $('.block_completion_progress .barRow').each(checkArrows), 250));\n\n            // Handle the 'now' marker on page load and if a dynamic table updates.\n            $(document).on('core_table/dynamic:tableContentRefreshed', function(e) {\n                if (e.target.matches && e.target.matches('.table-dynamic[data-table-handler=\"overview\"]' +\n                        '[data-table-component=\"block_completion_progress\"]')) {\n                    positionNow();\n                }\n            });\n            $(() => positionNow());\n\n            // Rerender the block if a student manually completes an activity on the course page.\n            $(document).on('core_course:manualcompletiontoggled', e => rerenderBlocksWithCmid(e.target.dataset.cmid));\n        }\n\n        return /** @alias module:block_completion_progress/progressbar */ {\n            init: init\n        };\n    });\n"],"names":["define","$","Ajax","Log","Templates","Utils","showInfo","event","cell","this","container","closest","visibleinfo","siblings","infotoshow","data","is","hide","show","preventDefault","showAllInfo","initialinfo","viewActivity","infolink","find","first","prop","click","document","location","scrollContainer","barrow","amount","checkArrows","barcontainer","leftarrow","rightarrow","scrolled","scrollWidth","threshold","Math","floor","width","dir","css","positionNow","barel","barrows","each","nowicon","offset","left","init","body","on","addEventListener","e","target","matches","call","window","resize","debounce","rerenderBlocksWithCmid","cmid","dataset","block","blockcontent","courseid","instanceid","userid","debug","methodname","args","done","response","render","html","js","newcontent","replaceNode","fail","ex","errorcode"],"mappings":"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"}