/**
 * Completion Progress block progress bar behaviour.
 *
 * @module     block_completion_progress/progressbar
 * @copyright  2020 Jonathon Fowler <fowlerj@usq.edu.au>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_completion_progress/progressbar",["jquery","core/ajax","core/log","core/templates","core/utils"],(function($,Ajax,Log,Templates,Utils){function showInfo(event){var cell=$(this),container=cell.closest(".block_completion_progress .barContainer"),visibleinfo=container.siblings(".progressEventInfo:visible"),infotoshow=container.siblings(".progressEventInfo[data-inforef="+cell.data("inforef")+"]");visibleinfo.is(infotoshow)||(visibleinfo.hide(),infotoshow.show()),event.preventDefault()}function showAllInfo(event){var initialinfo=$(this).closest(".progressEventInfo");initialinfo.siblings(".progressEventInfo").show(),initialinfo.hide(),event.preventDefault()}function viewActivity(){var cell=$(this),infolink=cell.closest(".block_completion_progress .barContainer").siblings(".progressEventInfo[data-inforef="+cell.data("inforef")+"]").find("a").first();null!==infolink.prop("onclick")?infolink.click():document.location=infolink.prop("href")}function scrollContainer(event){var barrow=$(this).closest(".block_completion_progress .barContainer").find(".barRow"),amount=event.data*barrow.prop("scrollWidth")*.15;barrow.prop("scrollLeft",barrow.prop("scrollLeft")+amount),event.preventDefault()}function checkArrows(){var barrow=$(this),barcontainer=barrow.closest(".block_completion_progress .barContainer"),leftarrow=barcontainer.find(".left-arrow-svg"),rightarrow=barcontainer.find(".right-arrow-svg"),scrolled=barrow.prop("scrollLeft"),scrollWidth=barrow.prop("scrollWidth")-barrow.prop("offsetWidth"),threshold=Math.floor(.25*barrow.find(".progressBarCell:first-child").width());"rtl"===document.dir?((scrolled=-scrolled)>threshold?rightarrow.css("display","block"):rightarrow.css("display","none"),scrollWidth>threshold&&scrolled<scrollWidth-threshold?leftarrow.css("display","block"):leftarrow.css("display","none")):(scrolled>threshold?leftarrow.css("display","block"):leftarrow.css("display","none"),scrollWidth>threshold&&scrolled<scrollWidth-threshold?rightarrow.css("display","block"):rightarrow.css("display","none"))}function positionNow(barel){var barrows;(barrows=void 0!==barel?barel.find(".barRow"):$(".block_completion_progress .barRow")).find(".nowDiv .icon").each((function(){var nowicon=$(this),barrow=nowicon.closest(".block_completion_progress .barRow");barrow.prop("scrollLeft",0),barrow.prop("scrollLeft",nowicon.offset().left-barrow.offset().left-barrow.width()/2)})),barrows.each(checkArrows)}return{init:function(){$(document.body).on("touchstart mouseover",".block_completion_progress .progressBarCell",showInfo),$(document.body).on("click",".block_completion_progress .progressBarCell[data-haslink=true]",viewActivity),$(document.body).on("click",".block_completion_progress .progressShowAllInfo",showAllInfo),document.addEventListener("scroll",(function(e){e.target.matches&&e.target.matches(".block_completion_progress .barRow")&&checkArrows.call(e.target)}),!0),$(document.body).on("click",".block_completion_progress .left-arrow-svg",-1,scrollContainer),$(document.body).on("click",".block_completion_progress .right-arrow-svg",1,scrollContainer),$(window).resize((()=>$(".block_completion_progress .barRow").each(checkArrows))),$(document).on("theme_boost/drawers:shown theme_boost/drawers:hidden",Utils.debounce((()=>$(".block_completion_progress .barRow").each(checkArrows)),250)),$(document).on("core_table/dynamic:tableContentRefreshed",(function(e){e.target.matches&&e.target.matches('.table-dynamic[data-table-handler="overview"][data-table-component="block_completion_progress"]')&&positionNow()})),$((()=>positionNow())),$(document).on("core_course:manualcompletiontoggled",(e=>{return cmid=e.target.dataset.cmid,void $('.block.block_completion_progress:has(.progressBarCell[data-inforef$="-'+cmid+'"])').each((function(){let block=$(this),blockcontent=block.find("div.block_completion_progress"),barcontainer=block.find(".barContainer"),courseid=barcontainer.data("courseid"),instanceid=barcontainer.data("instanceid"),userid=barcontainer.data("userid");Log.debug("block_completion_progress: reloading course ".concat(courseid," blockinstance ").concat(instanceid," user ").concat(userid)),Ajax.call([{methodname:"block_completion_progress_get_blockinstance_data",args:{courseid:courseid,instanceid:instanceid,userid:userid},done:function(response){Templates.render("block_completion_progress/completion_progress",response).done((function(html,js){let newcontent=Templates.replaceNode(blockcontent,html,js);positionNow($(newcontent[0]))})).fail((ex=>Log.debug("block_completion_progress: error rendering template to reload "+"course ".concat(courseid," blockinstance ").concat(instanceid," user ").concat(userid," -- ").concat(ex.errorcode))))},fail:ex=>Log.debug("block_completion_progress: error making ajax call to reload "+"course ".concat(courseid," blockinstance ").concat(instanceid," user ").concat(userid," -- ").concat(ex.errorcode))}],!0,!0,!0)}));var cmid}))}}}));

//# sourceMappingURL=progressbar.min.js.map